<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Photo Tracker</title>
    <style>
        body { font-family: sans-serif; background: #eceff1; display: flex; justify-content: center; padding: 20px; }
        .card { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 25px rgba(0,0,0,0.1); width: 100%; max-width: 450px; text-align: center; }
        #preview { width: 100%; border-radius: 10px; margin: 15px 0; display: none; border: 1px solid #ddd; }
        .info { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 5px solid #4285F4; text-align: left; }
        .btn-map { display: none; margin-top: 15px; padding: 12px; background: #4285F4; color: white; text-decoration: none; border-radius: 8px; font-weight: bold; text-align: center; }
        .loader { display: none; color: #4285F4; font-weight: bold; margin: 10px 0; }
    </style>
</head>
<body>

<div class="card">
    <h2>üåç Universal Photo Tracker</h2>
    <p>Upload any photo (JPG, PNG, HEIC)</p>
    
    <input type="file" id="upload" accept="image/*">
    
    <div id="loader" class="loader">Converting/Processing...</div>
    <img id="preview" src="" alt="Preview">

    <div class="info">
        <div id="status">Waiting for file...</div>
        <div id="coords" style="margin-top:5px; font-family: monospace; font-size: 0.9em;"></div>
    </div>

    <a id="mapLink" class="btn-map" target="_blank">üìç View on Google Maps</a>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/heic2any@0.0.3/dist/heic2any.min.js"></script>

<script>
    const upload = document.getElementById('upload');
    const status = document.getElementById('status');
    const coords = document.getElementById('coords');
    const mapLink = document.getElementById('mapLink');
    const preview = document.getElementById('preview');
    const loader = document.getElementById('loader');

    upload.onchange = async function(e) {
        let file = e.target.files[0];
        if (!file) return;

        loader.style.display = "block";
        status.innerText = "Analyzing file...";
        coords.innerText = "";
        mapLink.style.display = "none";
        preview.style.display = "none";

        // 1. Handle HEIC conversion if necessary
        if (file.name.toLowerCase().endsWith(".heic")) {
            try {
                const convertedBlob = await heic2any({ blob: file, toType: "image/jpeg" });
                file = new File([convertedBlob], file.name.replace(/\.heic/i, ".jpg"), { type: "image/jpeg" });
            } catch (err) {
                console.error("HEIC conversion failed", err);
            }
        }

        // 2. Show Preview
        const reader = new FileReader();
        reader.onload = (event) => {
            preview.src = event.target.result;
            preview.style.display = "block";
            loader.style.display = "none";
        };
        reader.readAsDataURL(file);

        // 3. Extract GPS Data
        EXIF.getData(file, function() {
            const lat = EXIF.getTag(this, "GPSLatitude");
            const lon = EXIF.getTag(this, "GPSLongitude");

            if (lat && lon) {
                const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";
                
                const latDec = convertToDecimal(lat, latRef);
                const lonDec = convertToDecimal(lon, lonRef);

                status.innerHTML = "‚úÖ <strong>Location Found!</strong>";
                coords.innerHTML = `Latitude: ${latDec.toFixed(6)}<br>Longitude: ${lonDec.toFixed(6)}`;
                
                mapLink.href = `https://www.google.com/maps?q=${latDec},${lonDec}`;
                mapLink.style.display = "block";
            } else {
                status.innerText = "‚ùå No Location Data Found";
                alert("This file has no GPS coordinates.\n\nNote: Messaging apps (WhatsApp/Telegram) and screenshots do not contain location data.");
                coords.innerText = "Try an original camera photo.";
            }
        });
    };

    function convertToDecimal(gpsData, ref) {
        let d = gpsData[0].numerator / gpsData[0].denominator;
        let m = gpsData[1].numerator / gpsData[1].denominator;
        let s = gpsData[2].numerator / gpsData[2].denominator;
        let decimal = d + (m / 60) + (s / 3600);
        if (ref === "S" || ref === "W") decimal = decimal * -1;
        return decimal;
    }
</script>

</body>
</html>
