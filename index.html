<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strict Camera Tracker</title>
    <style>
        body { font-family: -apple-system, sans-serif; background: #000; color: white; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { text-align: center; width: 90%; max-width: 400px; }
        
        /* The "Shutter" Button */
        .btn-camera {
            background: white;
            border: 5px solid #444;
            width: 90px;
            height: 90px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 30px;
            box-shadow: 0 0 20px rgba(255,255,255,0.2);
            transition: transform 0.1s;
        }
        .btn-camera:active { transform: scale(0.9); }
        
        #preview { width: 100%; border-radius: 15px; margin-top: 20px; display: none; border: 1px solid #333; }
        
        .info-card {
            background: #1c1c1e;
            padding: 15px;
            border-radius: 12px;
            margin-top: 20px;
            text-align: left;
            display: none;
        }
        .status-badge { font-size: 11px; font-weight: bold; padding: 3px 8px; border-radius: 5px; margin-bottom: 8px; display: inline-block; }
        .live-bg { background: #007aff; }
        .exif-bg { background: #34c759; }
        
        .btn-map {
            display: block;
            background: #0a84ff;
            color: white;
            text-decoration: none;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <h2>Snap & Track</h2>
    <p style="color: #888;">Camera will open automatically</p>

    <input type="file" id="camInput" accept="image/*" capture="environment" style="display: none;">
    
    <button class="btn-camera" onclick="document.getElementById('camInput').click()">ðŸ“¸</button>

    <img id="preview" alt="Captured Photo">

    <div id="infoCard" class="info-card">
        <div id="source" class="status-badge"></div>
        <div id="coords" style="font-family: monospace;"></div>
        <a id="mapLink" class="btn-map" target="_blank">View on Map</a>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>

<script>
    let deviceLat = null;
    let deviceLon = null;

    // 1. Request GPS immediately when page loads
    window.onload = function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    deviceLat = pos.coords.latitude;
                    deviceLon = pos.coords.longitude;
                },
                (err) => { alert("Location access is required for this tool."); },
                { enableHighAccuracy: true }
            );
        }
    };

    document.getElementById('camInput').onchange = function(e) {
        const file = e.target.files[0];
        if (!file) return;

        // Show image preview
        const reader = new FileReader();
        reader.onload = (event) => {
            const preview = document.getElementById('preview');
            preview.src = event.target.result;
            preview.style.display = "block";
        };
        reader.readAsDataURL(file);

        // 2. Metadata Check with Auto-Fallback
        EXIF.getData(file, function() {
            const exifLat = EXIF.getTag(this, "GPSLatitude");
            const exifLon = EXIF.getTag(this, "GPSLongitude");

            let lat, lon, isExif;

            if (exifLat && exifLon) {
                // Use data from the photo file itself
                const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
                const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";
                lat = convertToDecimal(exifLat, latRef);
                lon = convertToDecimal(exifLon, lonRef);
                isExif = true;
            } else if (deviceLat !== null) {
                // Fallback to the live location we grabbed on load
                lat = deviceLat;
                lon = deviceLon;
                isExif = false;
            } else {
                alert("Could not determine location. Please ensure GPS is ON.");
                return;
            }

            displayResult(lat, lon, isExif);
        });
    };

    function displayResult(lat, lon, isExif) {
        document.getElementById('infoCard').style.display = "block";
        const source = document.getElementById('source');
        source.innerText = isExif ? "GPS: FROM PHOTO" : "GPS: LIVE FALLBACK";
        source.className = isExif ? "status-badge exif-bg" : "status-badge live-bg";
        
        document.getElementById('coords').innerHTML = `LAT: ${lat.toFixed(6)}<br>LON: ${lon.toFixed(6)}`;
        document.getElementById('mapLink').href = `https://www.google.com/maps?q=${lat},${lon}`;
    }

    function convertToDecimal(gpsData, ref) {
        let d = gpsData[0].numerator / gpsData[0].denominator;
        let m = gpsData[1].numerator / gpsData[1].denominator;
        let s = gpsData[2].numerator / gpsData[2].denominator;
        let decimal = d + (m / 60) + (s / 3600);
        if (ref === "S" || ref === "W") decimal = decimal * -1;
        return decimal;
    }
</script>

</body>
</html>
